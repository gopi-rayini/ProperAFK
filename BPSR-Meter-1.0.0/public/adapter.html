<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BPSR Meter — Network Adapter</title>
    <style>
        :root { --bg:#0b0e14; --fg:#e6e6e6; --muted:#9aa4ad; --accent:#4ea1ff; --bad:#ff5c5c; --ok:#43d17b; }
        html,body { margin:0; padding:0; background:var(--bg); color:var(--fg); font:14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif; }
        .wrap { max-width: 860px; margin: 28px auto; padding: 0 16px; }
        h1 { font-size: 20px; margin:0 0 12px 0; }
        .card { background:#11151d; border:1px solid #1f2633; border-radius:12px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.25); }
        label { display:block; margin:8px 0 6px; color:var(--muted); }
        select, button, input[type="text"] {
          width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3242; background:#0f1320; color:var(--fg);
          outline:none;
        }
        button { cursor:pointer; background:#152038; border-color:#2a3852; }
        button.primary { background:var(--accent); border-color:#2f78c4; color:#071521; font-weight:600; }
        button.row { width:auto; padding:8px 12px; margin-left:8px; }
        .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
        .row > * { flex: 1 1 260px; }
        .hint { color:var(--muted); font-size:12px; margin-top:10px; }
        .status { margin-top:12px; }
        .pill { display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; }
        .ok { background:rgba(67,209,123,.12); color:var(--ok); border:1px solid rgba(67,209,123,.3); }
        .bad { background:rgba(255,92,92,.12); color:var(--bad); border:1px solid rgba(255,92,92,.3); }
        .muted { color:var(--muted); }
        .list { margin-top:8px; max-height: 340px; overflow:auto; border:1px solid #1f2633; border-radius:10px; }
        .item { padding:10px 12px; border-bottom:1px solid #1b2230; display:flex; gap:10px; align-items:flex-start; }
        .item:last-child { border-bottom:none; }
        .idx { width:42px; text-align:center; color:#8aa2c2; font-weight:700; }
        .desc { flex:1; }
        code { background:#0e1421; padding:2px 6px; border-radius:6px; border:1px solid #1b2230; }
        .actions { margin-top:14px; display:flex; gap:10px; align-items:center; }
    </style>
</head>
<body>
<div class="wrap">
    <h1>Network Adapter Selection</h1>
    <div class="card">
        <div class="row">
            <div>
                <label for="adapterSel">Available adapters</label>
                <select id="adapterSel"></select>
            </div>
            <div>
                <label for="adapterName">Or select by name</label>
                <input id="adapterName" type="text" placeholder="\\Device\\NPF_{GUID} or exact name" />
            </div>
        </div>
        <div class="actions">
            <button id="refreshBtn" class="row">Refresh list</button>
            <button id="applyBtn" class="primary row">Apply selection</button>
            <button id="testBtn" class="row">Test position</button>
        </div>
        <div class="status" id="status"></div>
        <div class="hint">
            Tip: If you use a VPN, pick its adapter. You can also run with arguments:
            <code>BPSR&nbsp;Meter.exe&nbsp;8989&nbsp;&lt;adapterIndex&gt;</code>
        </div>
    </div>

    <div class="card" style="margin-top:16px;">
        <div class="row" style="align-items:center;">
            <div class="muted">Enumerated adapters</div>
            <div style="text-align:right;">
                Current selection: <span id="currentSel" class="pill muted">unknown</span>
            </div>
        </div>
        <div id="list" class="list"></div>
    </div>
</div>

<script>
    const sel = document.getElementById('adapterSel');
    const nameInput = document.getElementById('adapterName');
    const status = document.getElementById('status');
    const listDiv = document.getElementById('list');
    const currentSel = document.getElementById('currentSel');

    function setStatus(text, ok=null) {
      status.innerHTML = '';
      if (!text) return;
      const span = document.createElement('span');
      span.className = 'pill ' + (ok===true ? 'ok' : ok===false ? 'bad' : 'muted');
      span.textContent = text;
      status.appendChild(span);
    }

    async function fetchJSON(url, opts) {
      const r = await fetch(url, opts);
      const t = await r.text();
      try { return { ok: r.ok, data: JSON.parse(t) }; }
      catch { return { ok: r.ok, data: t }; }
    }

    function renderList(items) {
      listDiv.innerHTML = '';
      items.forEach((d, i) => {
        const row = document.createElement('div');
        row.className = 'item';
        const idx = document.createElement('div');
        idx.className = 'idx';
        idx.textContent = d.index;
        const desc = document.createElement('div');
        desc.className = 'desc';
        const title = document.createElement('div');
        title.innerHTML = `<b>${d.name || '(no name)'}</b>`;
        const meta = document.createElement('div');
        meta.className = 'muted';
        meta.textContent = (d.description || '') + (d.addresses?.length ? ` — ${d.addresses.join(', ')}` : '');
        desc.appendChild(title);
        desc.appendChild(meta);
        row.appendChild(idx);
        row.appendChild(desc);
        listDiv.appendChild(row);
      });
    }

    async function loadAdapters() {
      setStatus('Loading adapters…');
      const res = await fetchJSON('/api/adapters');
      if (!res.ok) { setStatus('Failed to load adapters', false); return; }
      const { data:list, selected } = res.data;
      sel.innerHTML = '';
      list.forEach(d => {
        const o = document.createElement('option');
        o.value = d.index;
        o.textContent = `[${d.index}] ${d.name || '(no name)'} — ${d.description || ''}`;
        sel.appendChild(o);
      });
      if (typeof selected === 'number' && selected >= 0 && selected < list.length) {
        sel.value = String(selected);
        currentSel.textContent = `#${selected}`;
        currentSel.className = 'pill ok';
      } else {
        currentSel.textContent = 'none';
        currentSel.className = 'pill muted';
      }
      renderList(list);
      setStatus('Ready', true);
    }

    async function applySelection() {
      const idx = parseInt(sel.value, 10);
      const name = nameInput.value.trim() || undefined;
      setStatus('Applying…');
      const res = await fetchJSON('/api/adapter', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(name ? { name } : { index: idx })
      });
      if (!res.ok || !res.data || res.data.code !== 0) {
        setStatus('Apply failed', false);
        return;
      }
      const { live, selected } = res.data;
      currentSel.textContent = `#${selected}`;
      currentSel.className = 'pill ok';
      setStatus(live ? 'Switched live' : 'Saved. Restart to apply', live);
    }

    async function testPosition() {
      setStatus('Testing…');
      const r = await fetchJSON('/api/position');
      if (r.ok && r.data && r.data.code === 0) {
        const p = r.data.pos;
        setStatus(`OK: x=${p.x?.toFixed?.(2)??p.x}, y=${p.y?.toFixed?.(2)??p.y}`, true);
      } else {
        setStatus('No position yet. Move once in-game.', false);
      }
    }

    document.getElementById('refreshBtn').onclick = loadAdapters;
    document.getElementById('applyBtn').onclick = applySelection;
    document.getElementById('testBtn').onclick = testPosition;

    loadAdapters();
</script>
</body>
</html>
